# Orchestrator v0 (Preview)

Status: preview-gated via `ORCH_ENABLED=true`

## Overview

The Orchestrator runs task jobs through simple steps with safety limits. v0 uses an in-memory queue and emits Server-Sent Events (SSE) for live progress. Optional Redis may be added later via `ORCH_BACKEND=redis`.

## Flags

- `ORCH_ENABLED` (`true|false`): enable routes.
- `ORCH_MODE` (`mock|live`): presentation only; workers are no-op unless wired to scripts.
- `ORCH_BACKEND` (`memory|redis`): v0 ships with memory; redis reserved.
- `ORCH_MAX_REQUEST_BYTES` (default 32768): payload limit.

## Security (CORS & Headers)

- Stateless API surface; no cookies are required or read.
- CORS policy for orchestrator endpoints:
  - OPTIONS returns 204 with Access-Control-Allow-Origin: * and standard method/header lists.
  - Non-OPTIONS responses include Access-Control-Allow-Origin: * and must not include Access-Control-Allow-Credentials: true.
- Implication: Browsers do not send cookies by default; CSRF protections are not applicable for this stateless, header-only surface.

Rate limiting & size caps
- Request size cap: `ORCH_MAX_REQUEST_BYTES` (default 32768 bytes) → 413 on exceed.
- Per-route rate limit (preview default): up to 20 POSTs per minute on `/api/orchestrator/jobs`.

## TODO (future)
- Introduce Session/CSRF only if we add credentialed flows (e.g., cookie-based auth) and enable Access-Control-Allow-Credentials: true. At that point, require double-submit CSRF: header X-CSRF-Token + csrf cookie, and reject on mismatch.

## Task Packet Schema

```json
{
  "goal": "string",
  "scope": "string?",
  "planRef": "string?",
  "steps": [ { "id?": "string", "type": "string", "payload?": {} } ],
  "limits": { "maxSteps": 3, "maxWallMs": 5000, "maxTokens?": 20000 },
  "flags": { "key": "value" }
}
```

## Endpoints

- POST `/api/orchestrator/jobs` → `{ job_id }` on valid JSON. Accepts camelCase limits; snake_case (`max_steps`, `max_wall_ms`, `max_tokens`) is normalized.
- GET `/api/orchestrator/jobs/:id` → `{ job_id, status, started_at?, finished_at?, error?, stepsRun }` with status in `queued|running|succeeded|failed|canceled`.
- GET `/api/orchestrator/jobs/:id/logs` (preview) → `{ job_id, logs: [{ t, level, msg, data? }] }` (recent N via `?n=`; default 50).
- POST `/api/orchestrator/jobs/:id/cancel` → `{ ok: true }` (idempotent; transitions running job to `canceled`).
- GET `/api/orchestrator/events?job=:id` (SSE) → `event: start|step.start|step.ok|step.retry|step.error|end`.

## Engine v0

- In-memory FIFO queue.
- Loop-guard: enforces `limits.maxSteps` and `limits.maxWallMs` (default 10s when omitted).
- Retry with jittered backoff (max 2 retries per step).

### Redis (optional)
- When `ORCH_BACKEND=redis` and `REDIS_URL` are set, a Redis-backed queue may be used (MVP keeps interface identical; in-memory is default).

## Workers (Adapters) v0

- `dev.log`, `repoops`, `ci`, `docs` → log-only mock; return `{ ok, notes }`.

## Integration Touchpoint (Epic #82)

- Reserved for a composite step (CertifiedPlan→Verify). v0 does not call external endpoints by default.

## OpenAPI

`api/openapi.yaml` includes `/api/orchestrator/jobs`, `/api/orchestrator/jobs/{id}`, `/api/orchestrator/events`.

## Examples

```bash
curl -sS -X POST "$API_BASE/api/orchestrator/jobs" \
  -H 'content-type: application/json' \
  -d '{"goal":"hello","steps":[],"limits":{"maxSteps":3,"maxWallMs":2000}}'
```

Common errors
- Snake_case keys in `limits` (e.g., `max_steps`) will be normalized to camelCase, but older clients may receive 400 if other required fields are missing. Prefer camelCase keys.
- Payloads exceeding `ORCH_MAX_REQUEST_BYTES` return 413: `{ error: { code: "PAYLOAD_TOO_LARGE", details: { max_bytes } } }`.

Status check
- Staging should serve `GET /__whoami` with `xOrchestratorEnabled: "true"` in the JSON body when orchestrator is enabled.

# snake_case limits accepted
curl -sS -X POST "$API_BASE/api/orchestrator/jobs" \
  -H 'content-type: application/json' \
  -d '{"goal":"hello","steps":[],"limits":{"max_steps":3,"max_wall_ms":2000}}'

curl -sS "$API_BASE/api/orchestrator/events?job=$JOB_ID"
```


