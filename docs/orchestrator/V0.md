# Orchestrator v0 (Preview)

Status: preview-gated via `ORCH_ENABLED=true`

## Overview

The Orchestrator runs task jobs through simple steps with safety limits. v0 uses an in-memory queue and emits Server-Sent Events (SSE) for live progress. Optional Redis may be added later via `ORCH_BACKEND=redis`.

## Flags

- `ORCH_ENABLED` (`true|false`): enable routes.
- `ORCH_MODE` (`mock|live`): presentation only; workers are no-op unless wired to scripts.
- `ORCH_BACKEND` (`memory|redis`): v0 ships with memory; redis reserved.
- `ORCH_MAX_REQUEST_BYTES` (default 32768): payload limit.

## Security (CORS & Headers)

- OPTIONS preflight on `/api/orchestrator/*` returns 204 and includes `Access-Control-Allow-Origin: *`.
- Non-OPTIONS responses include `X-Content-Type-Options: nosniff`, `Referrer-Policy: no-referrer`, and `Access-Control-Allow-Origin: *`. No `Access-Control-Allow-Credentials: true` is set.
- Per-route rate limit applied to orchestrator POSTs.

## Task Packet Schema

```json
{
  "goal": "string",
  "scope": "string?",
  "planRef": "string?",
  "steps": [ { "id?": "string", "type": "string", "payload?": {} } ],
  "limits": { "maxSteps": 3, "maxWallMs": 5000 },
  "flags": { "key": "value" }
}
```

## Endpoints

- POST `/api/orchestrator/jobs` → `{ job_id }` on valid JSON. Accepts camelCase limits; snake_case (`max_steps`, `max_wall_ms`, `max_tokens`) is normalized.
- GET `/api/orchestrator/jobs/:id` → `{ job_id, status, started_at?, finished_at?, error?, stepsRun }` with status in `queued|running|succeeded|failed|canceled`.
- GET `/api/orchestrator/jobs/:id/logs` (preview) → `{ job_id, logs: [{ t, level, msg, data? }] }` (recent N via `?n=`; default 50).
- POST `/api/orchestrator/jobs/:id/cancel` → `{ ok: true }` (idempotent; transitions running job to `canceled`).
- GET `/api/orchestrator/events?job=:id` (SSE) → `event: start|step.start|step.ok|step.retry|step.error|end`.

## Engine v0

- In-memory FIFO queue.
- Loop-guard: enforces `limits.maxSteps` and `limits.maxWallMs` (default 10s when omitted).
- Retry with jittered backoff (max 2 retries per step).

### Redis (optional)
- When `ORCH_BACKEND=redis` and `REDIS_URL` are set, a Redis-backed queue may be used (MVP keeps interface identical; in-memory is default).

## Workers (Adapters) v0

- `dev.log`, `repoops`, `ci`, `docs` → log-only mock; return `{ ok, notes }`.

## Integration Touchpoint (Epic #82)

- Reserved for a composite step (CertifiedPlan→Verify). v0 does not call external endpoints by default.

## OpenAPI

`api/openapi.yaml` includes `/api/orchestrator/jobs`, `/api/orchestrator/jobs/{id}`, `/api/orchestrator/events`.

## Examples

```bash
curl -sS -X POST "$API_BASE/api/orchestrator/jobs" \
  -H 'content-type: application/json' \
  -d '{"goal":"hello","steps":[],"limits":{"maxSteps":3,"maxWallMs":2000}}'

# snake_case limits accepted
curl -sS -X POST "$API_BASE/api/orchestrator/jobs" \
  -H 'content-type: application/json' \
  -d '{"goal":"hello","steps":[],"limits":{"max_steps":3,"max_wall_ms":2000}}'

curl -sS "$API_BASE/api/orchestrator/events?job=$JOB_ID"
```


